#include "types.h"
#include "spinlock.h"
#include "sleeplock.h"
#include "fs.h"
#include "file.h"
#include "defs.h"
#include "devrand.h"

char randbuff[RAND_BUFF_SIZE] = {
    19,244,4,184,194,95,70,54,118,140,104,105,155,167,206,
    18,218,150,222,228,63,44,114,96,43,133,172,61,99,220,
    111,113,245,170,10,209,229,57,45,210,27,119,158,248,183,
    161,198,144,24,108,230,150,144,11,7,176,24,166,100,109,
    169,87,195,24,16,206,187,32,6,12,12,193,11,223,243,
    29,234,115,248,105,79,9,30,57,214,5,38,239,232,196,
    238,126,161,3,144,87,253,206,43,131,86,77,151,7,59,
    76,185,92,153,169,100,23,111,196,212,186,7,124,111,156,
    108,23,232,12,55,221,42,25,160,230,87,214,138,28,83,
    15,7,218,230,40,153,104,187,225,145,19,132,253,132,121,
    207,157,216,100,105,38,184,80,238,13,175,237,222,187,216,
    33,57,50,219,235,204,25,52,142,2,61,150,136,37,192,
    104,176,244,162,188,132,99,38,220,225,67,207,30,2,157,
    15,246,224,132,15,56,216,222,32,115,108,24,165,223,116,
    142,94,160,42,155,11,110,8,206,184,177,88,250,41,149,
    228,174,202,115,80,80,91,39,206,124,53,135,27,202,170,
    18,106,245,186,147,83,69,142,90,178,78,96,164,222,195,
    96,19,217,136,59,30,57,155,133,107,141,170,17,83,218,
    229,218,55,57,67,198,65,132,176,218,88,178,218,193,51,
    183,62,44,11,188,126,142,122,247,72,27,164,89,174,149,
    161,155,25,4,228,103,216,79,191,133,113,49,174,101,210,
    57,138,112,245,176,232,240,19,106,228,171,59,178,40,84,
    174,163,20,216,50,96,147,157,82,184,219,199,240,63,194,
    185,251,164,49,173,82,48,188,207,144,96,177,63,66,193,
    110,147,153,97,173,130,175,98,4,78,33,108,126,105,102,
    145,72,118,66,124,37,20,84,117,7,151,75,126,233,159,
    33,76,40,64,36,107,31,183,41,224,102,12,252,131,2,
    85,184,235,136,115,191,79,233,180,164,45,87,248,206,149,
    117,100,25,16,154,108,98,159,202,75,250,187,61,177,11,
    118,69,88,33,197,19,32,111,49,188,252,127,84,56,204,
    207,86,145,27,123,176,182,79,43,179,138,183,248,226,36,
    161,168,174,252,218,197,52,229,104,179,130,140,50,247,50,
    131,87,4,9,248,107,55,25,76,70,226,193,88,79,120,
    183,86,89,195,27,193,100,78,2,166,153,152,208,255,184,
    159,179
};

int
devrandread(struct inode *ip, char *buf, int n, int offset)
{
    int i;

    for (i = 0; i < n; i ++) {
        randbuff[i % RAND_BUFF_SIZE] = (randbuff[i % RAND_BUFF_SIZE] + ticks) % MAX_RAND_NUM; 
        buf[i] = randbuff[i % RAND_BUFF_SIZE];
    }
    
	return i;
}

int
devrandwrite(struct inode *ip, char *buf, int n, int offset)
{
    int i;

    for (i = 0; i < n; i ++) {
        randbuff[i % RAND_BUFF_SIZE] = (randbuff[i % RAND_BUFF_SIZE] + ticks) % MAX_RAND_NUM; 
    }

	return i;
}

void
updateentropy(char c)
{
    int i;

    for (i = 0; i < RAND_BUFF_SIZE; i ++ ) {
        randbuff[i % RAND_BUFF_SIZE] = (randbuff[i % RAND_BUFF_SIZE] + ticks * c) % MAX_RAND_NUM;
    }
}

int
devrandinit()
{
    devsw[DEVRAND].read = devrandread;
    devsw[DEVRAND].write = devrandwrite;
}